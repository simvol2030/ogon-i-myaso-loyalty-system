# Feedback v1 - Flash Screens для TV-меню

**Дата:** 2025-12-27
**Branch to create:** `claude/flash-screens-v1`

---

## Описание задачи

Создать два маршрута `/flash-1` и `/flash-2` для отображения меню на TV-экранах в кафе. Слайды автоматически переключаются каждые 15 секунд с анимацией. Данные берутся из существующей БД (products + categories).

---

## Распределение категорий

### Flash-1 (Мангал)
| ID | Категория | Slug | Товаров |
|----|-----------|------|---------|
| 5 | Шашлык | shashlyk | 15 |
| 6 | Кебаб | kebab | 4 |
| 7 | Сеты | sety | 9 |

**Итого:** 28 товаров (19 обычных + 9 сетов)

### Flash-2 (Остальное меню)
| ID | Категория | Slug | Товаров |
|----|-----------|------|---------|
| 3 | Салаты | salaty | 7 |
| 4 | Супы | supy | 4 |
| 8 | Вторые блюда | vtorye-blyuda | 5 |
| 9 | Гарниры | garniry | 6 |
| 13 | Выпечка | vypechka | 11 |
| 11 | Пицца | pitstsa | 5 |
| 1 | Хинкали | hinkali | 5 |
| 10 | Хачапури | hachapuri | 2 |
| 12 | Шаурма | shaurma | 5 |
| 2 | Соусы | sousy | 3 |
| 14 | Напитки | napitki | 8 |

**Итого:** 61 товар

---

## UI Спецификация

### Общие параметры
- **Ориентация:** Landscape 16:9 (для TV)
- **Тема:** Telegram Dark
- **Размер шрифтов:** Увеличенный (читаемость с расстояния)
- **Интервал смены:** 15 секунд
- **Анимация:** Fade или slide transition

### Цветовая схема (Telegram Dark)
```css
--bg-primary: #1E1E1E;      /* Фон страницы */
--bg-card: #2A2A2A;         /* Фон карточек */
--text-primary: #FFFFFF;     /* Основной текст */
--text-secondary: #8E8E93;   /* Вторичный текст */
--accent: #64B5F6;          /* Акцент (категория) */
--price: #4CAF50;           /* Цена */
```

### Layout 1: Обычные товары (6x3 = 18 на слайд)

```
+------------------------------------------------------------------------------+
|  |КАТЕГОРИЯ                                                       [****]    |
+------------------------------------------------------------------------------+
|  +--------+ +--------+ +--------+ +--------+ +--------+ +--------+          |
|  | [фото] | | [фото] | | [фото] | | [фото] | | [фото] | | [фото] |          |
|  |Название| |Название| |Название| |Название| |Название| |Название|          |
|  | 400 P  | | 450 P  | | 550 P  | | 380 P  | | 400 P  | | 350 P  |          |
|  +--------+ +--------+ +--------+ +--------+ +--------+ +--------+          |
|  +--------+ +--------+ +--------+ +--------+ +--------+ +--------+          |
|  | [фото] | | [фото] | | [фото] | | [фото] | | [фото] | | [фото] |          |
|  |  ...   | |  ...   | |  ...   | |  ...   | |  ...   | |  ...   |          |
|  |  PPP   | |  PPP   | |  PPP   | |  PPP   | |  PPP   | |  PPP   |          |
|  +--------+ +--------+ +--------+ +--------+ +--------+ +--------+          |
|  +--------+ +--------+ +--------+ +--------+ +--------+ +--------+          |
|  | [фото] | | [фото] | | [фото] | | [фото] | | [фото] | | [фото] |          |
|  |  ...   | |  ...   | |  ...   | |  ...   | |  ...   | |  ...   |          |
|  |  PPP   | |  PPP   | |  PPP   | |  PPP   | |  PPP   | |  PPP   |          |
|  +--------+ +--------+ +--------+ +--------+ +--------+ +--------+          |
+------------------------------------------------------------------------------+
```

**Карточка товара:**
- Фото: aspect-ratio 1:1 или 4:3
- Название: 1-2 строки, truncate
- Цена: крупно, зелёный цвет
- quantity_info: мелко под названием (опционально)

### Layout 2: Сеты (3 на слайд)

```
+------------------------------------------------------------------------------+
|  |СЕТЫ                                                            [***]     |
+------------------------------------------------------------------------------+
|  +------------------------+ +------------------------+ +------------------------+
|  |                        | |                        | |                        |
|  |       [  фото  ]       | |       [  фото  ]       | |       [  фото  ]       |
|  |                        | |                        | |                        |
|  |       ХИТ СЕТ          | |       БИГ СЕТ          | |    КЕБАБНЫЙ СЕТ        |
|  |                        | |                        | |                        |
|  |  Люля говядина - 3 шт  | |  Баранина мякоть - 4   | |  Люля говядина - 3     |
|  |  Шашлык куриный - 2 шт | |  Свинина шея - 3 шт    | |  Кебаб из баранины     |
|  |  Овощи гриль - 1 порц  | |  Люля куриная - 5 шт   | |  Овощи гриль           |
|  |  Соус фирменный        | |  Картофель, овощи      | |  Лаваш, соусы          |
|  |                        | |                        | |                        |
|  |        3 390 P         | |       13 900 P         | |        5 900 P         |
|  +------------------------+ +------------------------+ +------------------------+
+------------------------------------------------------------------------------+
```

**Карточка сета:**
- Фото: большое, aspect-ratio 16:9 или 4:3
- Название: крупно, по центру
- Описание (description): многострочный список состава
- Цена: очень крупно, по центру

### Layout 3: Комбо (1 сет + 3x3 товаров)

Используется когда количество сетов не делится на 3 (остаток 1 или 2).

```
+------------------------------------------------------------------------------+
|  |СЕТЫ                          |  |НА МАНГАЛЕ                               |
+--------------------------------+---------------------------------------------+
|  +---------------------------+  |  +---------+ +---------+ +---------+      |
|  |                           |  |  | [фото]  | | [фото]  | | [фото]  |      |
|  |        [  фото  ]         |  |  |  Грибы  | |  Овощи  | |Картофель|      |
|  |                           |  |  |  250 P  | |  200 P  | |  180 P  |      |
|  |      НОВЫЙ СЕТ            |  |  +---------+ +---------+ +---------+      |
|  |                           |  |  +---------+ +---------+ +---------+      |
|  |  Состав сета подробно...  |  |  | [фото]  | | [фото]  | | [фото]  |      |
|  |  несколько строк          |  |  |  ...    | |  ...    | |  ...    |      |
|  |                           |  |  |  PPP    | |  PPP    | |  PPP    |      |
|  |         4 500 P           |  |  +---------+ +---------+ +---------+      |
|  |                           |  |  +---------+ +---------+ +---------+      |
|  +---------------------------+  |  | [фото]  | | [фото]  | | [фото]  |      |
|                                 |  |  ...    | |  ...    | |  ...    |      |
|                                 |  |  PPP    | |  PPP    | |  PPP    |      |
|                                 |  +---------+ +---------+ +---------+      |
+--------------------------------+---------------------------------------------+
```

---

## Логика генерации слайдов

### Flash-1 (Мангал)

```typescript
// Порядок слайдов для flash-1:
// 1. Все сеты (category_id = 7) - по 3 на слайд
// 2. Шашлык (category_id = 5) - по 18 на слайд
// 3. Кебаб (category_id = 6) - по 18 на слайд

// При текущих данных (9 сетов, 15 шашлык, 4 кебаб):
// Слайд 1: Сеты 1-3
// Слайд 2: Сеты 4-6
// Слайд 3: Сеты 7-9
// Слайд 4: Шашлык 1-15 (все влезают)
// Слайд 5: Кебаб 1-4 (все влезают, неполный слайд OK)

// Если сетов не кратно 3 (например 10):
// Слайды 1-3: по 3 сета
// Слайд 4: Комбо (1 сет + 9 шашлыков)
```

### Flash-2 (Остальное)

```typescript
// Порядок категорий (по position или вручную):
// 1. Салаты, 2. Супы, 3. Вторые блюда, 4. Гарниры,
// 5. Пицца, 6. Хинкали, 7. Хачапури, 8. Шаурма,
// 9. Выпечка, 10. Соусы, 11. Напитки

// Каждая категория - отдельная группа слайдов
// 18 товаров на слайд, если < 18 - неполный слайд OK
```

### Алгоритм

```typescript
interface Slide {
  type: 'products' | 'sets' | 'combo';
  category: string;
  items: Product[];
  setItem?: Product; // для combo
}

function generateSlides(products: Product[], category: Category): Slide[] {
  const slides: Slide[] = [];

  if (category.slug === 'sety') {
    // Сеты: по 3 на слайд
    const SETS_PER_SLIDE = 3;
    for (let i = 0; i < products.length; i += SETS_PER_SLIDE) {
      const chunk = products.slice(i, i + SETS_PER_SLIDE);
      if (chunk.length === SETS_PER_SLIDE) {
        slides.push({ type: 'sets', category: category.name, items: chunk });
      } else {
        // Остаток - combo слайд (обрабатывается отдельно)
        orphanSets.push(...chunk);
      }
    }
  } else {
    // Обычные товары: по 18 на слайд
    const ITEMS_PER_SLIDE = 18;
    for (let i = 0; i < products.length; i += ITEMS_PER_SLIDE) {
      slides.push({
        type: 'products',
        category: category.name,
        items: products.slice(i, i + ITEMS_PER_SLIDE)
      });
    }
  }

  return slides;
}
```

---

## API Endpoint

### GET `/api/flash/:screen`

**Параметры:**
- `screen`: `1` или `2`

**Ответ:**
```typescript
interface FlashResponse {
  slides: Slide[];
  config: {
    interval: number;      // 15000 ms
    transition: string;    // 'fade' | 'slide'
    screen: 1 | 2;
  };
}
```

**Логика backend:**
1. Получить все активные категории (`is_active = 1`)
2. Отфильтровать по screen (flash-1 или flash-2)
3. Для каждой категории получить активные товары
4. Сгенерировать слайды по алгоритму выше
5. Вернуть массив слайдов + конфиг

---

## Структура компонентов (Frontend)

```
src/routes/
  flash-1/
    +page.svelte          # Flash screen 1
  flash-2/
    +page.svelte          # Flash screen 2

src/lib/components/flash/
  FlashContainer.svelte     # Главный контейнер с таймером
  SlideProducts.svelte      # Layout для обычных товаров (6x3)
  SlideSets.svelte          # Layout для сетов (3 в ряд)
  SlideCombo.svelte         # Layout комбо (сет + товары)
  ProductCard.svelte        # Карточка товара (маленькая)
  SetCard.svelte            # Карточка сета (большая)
  SlideIndicator.svelte     # Индикатор текущего слайда [****]
  types.ts                  # Типы
```

### FlashContainer.svelte (основа)

```svelte
<script lang="ts">
  import { onMount, onDestroy } from 'svelte';

  let { slides, config } = $props<{ slides: Slide[], config: Config }>();

  let currentIndex = $state(0);
  let intervalId: number;

  onMount(() => {
    intervalId = setInterval(() => {
      currentIndex = (currentIndex + 1) % slides.length;
    }, config.interval);
  });

  onDestroy(() => clearInterval(intervalId));
</script>

<div class="flash-container">
  {#each slides as slide, i}
    <div class="slide" class:active={i === currentIndex}>
      {#if slide.type === 'products'}
        <SlideProducts {slide} />
      {:else if slide.type === 'sets'}
        <SlideSets {slide} />
      {:else}
        <SlideCombo {slide} />
      {/if}
    </div>
  {/each}

  <SlideIndicator total={slides.length} current={currentIndex} />
</div>

<style>
  .flash-container {
    width: 100vw;
    height: 100vh;
    background: var(--bg-primary);
    overflow: hidden;
    position: relative;
  }

  .slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }

  .slide.active {
    opacity: 1;
  }
</style>
```

---

## Файлы для создания/изменения

### Новые файлы (Frontend)
1. `src/routes/flash-1/+page.svelte`
2. `src/routes/flash-1/+page.server.ts`
3. `src/routes/flash-2/+page.svelte`
4. `src/routes/flash-2/+page.server.ts`
5. `src/lib/components/flash/FlashContainer.svelte`
6. `src/lib/components/flash/SlideProducts.svelte`
7. `src/lib/components/flash/SlideSets.svelte`
8. `src/lib/components/flash/SlideCombo.svelte`
9. `src/lib/components/flash/ProductCard.svelte`
10. `src/lib/components/flash/SetCard.svelte`
11. `src/lib/components/flash/SlideIndicator.svelte`
12. `src/lib/components/flash/types.ts`

### Новые файлы (Backend)
13. `src/routes/flash.ts`

### Изменения
14. `src/index.ts` - добавить роут `/api/flash`

---

## Требования к реализации

### Обязательно
- [ ] Landscape-only ориентация (CSS)
- [ ] Telegram Dark тема (цвета выше)
- [ ] Автоматическая смена слайдов каждые 15 сек
- [ ] Плавная анимация перехода (fade)
- [ ] Индикатор текущего слайда
- [ ] Обработка пустых категорий (пропускать)
- [ ] Обработка отсутствующих изображений (placeholder)
- [ ] Полноэкранный режим без скролла

### Желательно
- [ ] Preload изображений следующего слайда
- [ ] CSS-переменные для лёгкой кастомизации
- [ ] Keyboard navigation (для тестирования: <- ->)

### НЕ нужно
- WebSocket / real-time обновления
- Кэширование на клиенте
- PWA / offline режим
- Мобильная версия

---

## Тестирование

1. Открыть `/flash-1` - проверить слайды мангала
2. Открыть `/flash-2` - проверить слайды остального меню
3. Подождать 15+ сек - проверить автопереключение
4. Проверить на реальном TV (если возможно)
5. Проверить обработку отсутствующих изображений
